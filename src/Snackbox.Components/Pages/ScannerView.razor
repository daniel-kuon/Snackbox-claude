@page "/scanner"
@using Microsoft.JSInterop
@using Snackbox.Components.Models
@using Snackbox.Components.Services
@using Snackbox.Components.Components
@inject IScannerService ScannerService
@inject IJSRuntime JS
@inject IStringLocalizer<SharedResources> L
@inject ILocalizationService Localization
@implements IDisposable

<PageTitle>@L["Scanner.PageTitle"]</PageTitle>

<div class="scanner-container">
    @if (!ScannerService.IsSessionActive)
    {
        <!-- Initial State: Waiting for user to scan -->
        <div class="scanner-idle">
            <div class="scanner-icon">📱</div>
            <h1 class="scanner-title">@L["Scanner.WelcomeTitle"]</h1>
            <p class="scanner-instruction">@L["Scanner.WelcomeInstruction"]</p>
        </div>
    }
    else if (ScannerService.CurrentSession != null)
    {
        var session = ScannerService.CurrentSession;
        var paypalUrl = $"https://paypal.me/dkuon/{Math.Abs(session.OpenAmount):F2}";

        <!-- Active Purchase Session -->
        <div class="scanner-active">
            <!-- Header with user info -->
            <div class="scanner-header">
                <div class="user-info">
                    <h2 class="user-name">@session.UserName</h2>
                    <div class="user-balance">
                        <span class="balance-label">@L["Scanner.Balance"]</span>
                        <span class="balance-amount @(session.OpenAmount < 0 ? "negative" : "positive")">
                            @session.OpenAmount.ToString("C")
                        </span>
                    </div>
                </div>
                <div class="language-select">
                    <label class="me-1" for="langSelectScanner" style="font-size: .9rem; opacity: .8;">Lang:</label>
                    <select id="langSelectScanner" class="form-select form-select-sm" style="width: auto;"
                            @onchange="async (e) => await OnLanguageChangedForUser(e, session.UserId)">
                        @foreach (var c in Localization.SupportedCultures)
                        {
                            <option value="@c.Name" selected="@(c.Name == Localization.CurrentCulture.Name)">@c.NativeName</option>
                        }
                    </select>
                </div>
                <div class="timer-container">
                    <div class="timer-circle">
                        <span class="timer-text">@_remainingSeconds</span>
                    </div>
                </div>
            </div>

            <!-- Main content area -->
            <div class="scanner-content">
                <!-- Left side: Purchase items and totals -->
                <div class="purchase-section">
                    <h3 class="section-title">@L["Scanner.ScannedAmounts"]</h3>

                    @if (session.ScannedBarcodes.Any())
                    {
                        <div class="items-list">
                            @foreach (var barcode in session.ScannedBarcodes)
                            {
                                <div class="purchase-item">
                                    <span class="item-name">@barcode.ScannedAt.ToString("HH:mm:ss")</span>
                                    <span class="item-price">@barcode.Amount.ToString("C")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-items">
                            <p>@L["Scanner.NoItems"]</p>
                        </div>
                    }

                    <div class="purchase-total">
                        <span class="total-label">@L["Scanner.Total"]</span>
                        <span class="total-amount">@session.TotalAmount.ToString("C")</span>
                    </div>

                    <!-- Last payment info -->
                    @if (session.LastPaymentDate.HasValue)
                    {
                        <div class="last-payment">
                            <div class="payment-label">@L["Scanner.LastPayment"]</div>
                            <div class="payment-details">
                                <span class="payment-amount">@session.LastPaymentAmount.ToString("C")</span>
                                <span class="payment-date">@session.LastPaymentDate.Value.ToString("dd MMM yyyy")</span>
                            </div>
                        </div>
                    }
                </div>

                <!-- Right side: QR Code -->
                <div class="qr-section">
                    <h3 class="section-title">@L["Scanner.PayViaPayPal"]</h3>
                    <div class="qr-code-wrapper">
                        <QRCodeComponent PayPalUrl="@paypalUrl" Size="400" />
                    </div>
                    <p class="qr-instruction">@L["Scanner.QRInstruction", Math.Abs(session.OpenAmount).ToString("C")]</p>
                </div>
            </div>

            <!-- Scan instruction at bottom -->
            <div class="scan-instruction">
                <p>@L["Scanner.ScanInstruction"]</p>
            </div>
        </div>
    }
</div>

@code {
    private int _remainingSeconds;
    private System.Timers.Timer? _countdownTimer;
    private string _barcodeBuffer = string.Empty;
    private DateTime _lastKeypressTime = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        ScannerService.OnPurchaseStarted += HandlePurchaseStarted;
        ScannerService.OnPurchaseUpdated += HandlePurchaseUpdated;
        ScannerService.OnPurchaseCompleted += HandlePurchaseCompleted;
        ScannerService.OnPurchaseTimeout += HandlePurchaseTimeout;
        Localization.OnCultureChanged += _ => InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('keypress', function(e) {
                    window.barcodeScanner.handleKeyPress(e.key);
                });

                window.barcodeScanner = {
                    handleKeyPress: function(key) {
                        DotNet.invokeMethodAsync('Snackbox.Components', 'HandleBarcodeInput', key);
                    }
                };
            ");
        }
    }

    private void HandlePurchaseStarted(PurchaseSession session)
    {
        _remainingSeconds = ScannerService.TimeoutSeconds;
        StartCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseUpdated(PurchaseSession session)
    {
        ResetCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseCompleted()
    {
        StopCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseTimeout()
    {
        StopCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public static async Task HandleBarcodeInput(string key)
    {
        // This will be called from JavaScript for each keypress
        // In production, implement proper barcode scanner handling
    }

    private void StartCountdownTimer()
    {
        _countdownTimer = new System.Timers.Timer(1000);
        _countdownTimer.Elapsed += (_, _) =>
        {
            _remainingSeconds--;
            InvokeAsync(StateHasChanged);

            if (_remainingSeconds <= 0)
            {
                StopCountdownTimer();
            }
        };
        _countdownTimer.Start();
    }

    private void ResetCountdownTimer()
    {
        StopCountdownTimer();
        StartCountdownTimer();
    }

    private void StopCountdownTimer()
    {
        if (_countdownTimer != null)
        {
            _countdownTimer.Stop();
            _countdownTimer.Dispose();
            _countdownTimer = null;
        }
    }

    private async Task OnLanguageChangedForUser(ChangeEventArgs e, string userId)
    {
        var value = e.Value?.ToString() ?? "en";
        await Localization.SetCultureAsync(value, userId);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ScannerService.OnPurchaseStarted -= HandlePurchaseStarted;
        ScannerService.OnPurchaseUpdated -= HandlePurchaseUpdated;
        ScannerService.OnPurchaseCompleted -= HandlePurchaseCompleted;
        ScannerService.OnPurchaseTimeout -= HandlePurchaseTimeout;
        Localization.OnCultureChanged -= _ => InvokeAsync(StateHasChanged);

        StopCountdownTimer();
    }
}
