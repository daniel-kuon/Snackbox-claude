@page "/admin/invoices"
@using Snackbox.Api.Dtos
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Invoices - Snackbox Admin</PageTitle>

<div class="container-fluid">
    <div class="page-header">
        <h2>Invoice Management</h2>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="ShowParseInvoice">
                <span class="icon">ðŸ“„</span> Parse Invoice
            </button>
            <button class="btn btn-success" @onclick="ShowCreateManual">
                <span class="icon">âž•</span> Create Invoice
            </button>
        </div>
    </div>

    @if (_showParseModal)
    {
        <div class="modal-backdrop" @onclick="CloseParseModal"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Parse Invoice</h5>
                    <button class="btn-close" @onclick="CloseParseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Invoice Format</label>
                        <select class="form-control" @bind="_parseFormat">
                            <option value="sonderposten">Lebensmittel-Sonderposten</option>
                            <option value="selgros">Selgros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paste Invoice Text</label>
                        <textarea class="form-control" rows="10" @bind="_invoiceText" 
                                  placeholder="Paste the invoice text here..."></textarea>
                    </div>
                    @if (_parseError != null)
                    {
                        <div class="alert alert-danger">@_parseError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseParseModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="ParseInvoice" disabled="@_isParsing">
                        @if (_isParsing)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Parse
                    </button>
                </div>
            </div>
        </div>
    }

    @if (_parsedInvoice != null)
    {
        <div class="modal-backdrop"></div>
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Review Parsed Invoice</h5>
                    <button class="btn-close" @onclick="CloseParsedModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Invoice Number *</label>
                                <input type="text" class="form-control" @bind="_parsedInvoice!.Metadata!.InvoiceNumber" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Invoice Date *</label>
                                <input type="date" class="form-control" value="@_parsedInvoiceDate" 
                                       @oninput="@(e => _parsedInvoiceDate = e.Value?.ToString() ?? DateTime.Now.ToString("yyyy-MM-dd"))" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Supplier *</label>
                                <input type="text" class="form-control" @bind="_parsedInvoice!.Metadata!.Supplier" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Additional Costs (Shipping, etc.)</label>
                                <input type="number" step="0.01" class="form-control" @bind="_additionalCosts" />
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" rows="2" @bind="_invoiceNotes"></textarea>
                    </div>

                    <h6 class="mt-4">Items (@_parsedInvoice.Items.Count(i => i.Selected) selected)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" checked="@_selectAll" 
                                               @onchange="ToggleSelectAll" />
                                    </th>
                                    <th>Product Name</th>
                                    <th>Article #</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Best Before</th>
                                    <th>Match</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _parsedInvoice.Items)
                                {
                                    <tr class="@(item.Selected ? "" : "text-muted")">
                                        <td>
                                            <input type="checkbox" @bind="item.Selected" />
                                        </td>
                                        <td>@item.ProductName</td>
                                        <td><small>@item.ArticleNumber</small></td>
                                        <td>@item.Quantity</td>
                                        <td>â‚¬@item.UnitPrice.ToString("F2")</td>
                                        <td>â‚¬@item.TotalPrice.ToString("F2")</td>
                                        <td>
                                            @if (item.BestBeforeDate.HasValue)
                                            {
                                                @item.BestBeforeDate.Value.ToString("dd.MM.yyyy")
                                            }
                                        </td>
                                        <td>
                                            @if (item.MatchedProductId.HasValue)
                                            {
                                                <span class="badge bg-success" title="@item.MatchType">
                                                    âœ“ @item.MatchedProductName (@((item.MatchConfidence!.Value * 100).ToString("F0"))%)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">No match</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    @if (_createError != null)
                    {
                        <div class="alert alert-danger">@_createError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseParsedModal">Cancel</button>
                    <button class="btn btn-success" @onclick="CreateFromParsed" disabled="@_isCreating">
                        @if (_isCreating)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Create Invoice
                    </button>
                </div>
            </div>
        </div>
    }

    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading invoices...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }
    else if (_invoices != null && _invoices.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Created By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invoice in _invoices)
                    {
                        <tr @onclick="() => ViewInvoice(invoice.Id)" style="cursor: pointer;">
                            <td>@invoice.InvoiceNumber</td>
                            <td>@invoice.InvoiceDate.ToString("dd.MM.yyyy")</td>
                            <td>@invoice.Supplier</td>
                            <td>@invoice.Items.Count</td>
                            <td>â‚¬@invoice.TotalAmount.ToString("F2")</td>
                            <td>@invoice.CreatedByUsername</td>
                            <td @onclick:stopPropagation="true">
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteInvoice(invoice.Id)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="empty-state">
            <p>No invoices found. Create one to get started!</p>
        </div>
    }
</div>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        max-height: 90vh;
        overflow-y: auto;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        width: 600px;
        max-width: 90vw;
    }

    .modal-dialog.modal-xl {
        width: 1200px;
        max-width: 95vw;
    }

    .modal-content {
        padding: 0;
    }

    .modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .loading-container {
        text-align: center;
        padding: 3rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .icon {
        margin-right: 0.5rem;
    }

    .btn-close {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        opacity: 0.5;
    }

    .btn-close:hover {
        opacity: 1;
    }
</style>

@code {
    private List<InvoiceDto>? _invoices;
    private bool _isLoading = true;
    private string? _errorMessage;
    private bool _showParseModal = false;
    private bool _isParsing = false;
    private string _parseFormat = "sonderposten";
    private string _invoiceText = "";
    private string? _parseError;
    private ParseInvoiceResponse? _parsedInvoice;
    private string _parsedInvoiceDate = DateTime.Now.ToString("yyyy-MM-dd");
    private decimal _additionalCosts = 0;
    private decimal _priceReduction = 0;
    private string _invoiceNotes = "";
    private bool _selectAll = true;
    private bool _isCreating = false;
    private string? _createError;
    
    // User selection
    private List<UserDto>? _users;
    private int _paidByUserId = 0;
    private int _currentUserId = 0;
    
    // Product search and matching
    private List<ProductDto>? _allProducts;
    private Dictionary<int, List<ProductDto>> _itemSuggestions = new();
    private Dictionary<int, string> _searchTerms = new();
    private Dictionary<int, bool> _showingSearch = new();
    private Dictionary<int, int?> _selectedProductIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoices();
        await LoadUsers();
        await LoadProducts();
    }

    private async Task LoadInvoices()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _invoices = await Http.GetFromJsonAsync<List<InvoiceDto>>("api/invoices");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load invoices: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            _users = await Http.GetFromJsonAsync<List<UserDto>>("api/users");
            // Get current user ID from the first admin user or first user
            var currentUser = _users?.FirstOrDefault(u => u.IsAdmin);
            if (currentUser != null)
            {
                _currentUserId = currentUser.Id;
                _paidByUserId = currentUser.Id; // Default to current user
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load users: {ex.Message}";
        }
    }

    private async Task LoadProducts()
    {
        try
        {
            _allProducts = await Http.GetFromJsonAsync<List<ProductDto>>("api/products");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load products: {ex.Message}";
        }
    }

    private void ShowParseInvoice()
    {
        _showParseModal = true;
        _invoiceText = "";
        _parseError = null;
    }

    private void CloseParseModal()
    {
        _showParseModal = false;
    }

    private void ShowCreateManual()
    {
        Navigation.NavigateTo("/admin/invoices/create");
    }

    private async Task ParseInvoice()
    {
        _isParsing = true;
        _parseError = null;

        try
        {
            var request = new ParseInvoiceRequest
            {
                InvoiceText = _invoiceText,
                Format = _parseFormat
            };

            var response = await Http.PostAsJsonAsync("api/invoices/parse", request);
            
            if (response.IsSuccessStatusCode)
            {
                _parsedInvoice = await response.Content.ReadFromJsonAsync<ParseInvoiceResponse>();
                
                if (_parsedInvoice?.Success == true)
                {
                    if (_parsedInvoice.Metadata?.InvoiceDate.HasValue == true)
                    {
                        _parsedInvoiceDate = _parsedInvoice.Metadata.InvoiceDate.Value.ToString("yyyy-MM-dd");
                    }
                    
                    // Set price reduction if detected
                    if (_parsedInvoice.Metadata?.PriceReduction.HasValue == true)
                    {
                        _priceReduction = _parsedInvoice.Metadata.PriceReduction.Value;
                    }
                    
                    // Initialize product selections for each item
                    _selectedProductIds.Clear();
                    _searchTerms.Clear();
                    _showingSearch.Clear();
                    _itemSuggestions.Clear();
                    
                    for (int i = 0; i < _parsedInvoice.Items.Count; i++)
                    {
                        var item = _parsedInvoice.Items[i];
                        if (item.MatchedProductId.HasValue)
                        {
                            _selectedProductIds[i] = item.MatchedProductId.Value;
                        }
                    }
                    
                    _showParseModal = false;
                }
                else
                {
                    _parseError = _parsedInvoice?.ErrorMessage ?? "Failed to parse invoice";
                }
            }
            else
            {
                _parseError = "Failed to parse invoice";
            }
        }
        catch (Exception ex)
        {
            _parseError = $"Error: {ex.Message}";
        }
        finally
        {
            _isParsing = false;
        }
    }

    private void CloseParsedModal()
    {
        _parsedInvoice = null;
        _additionalCosts = 0;
        _priceReduction = 0;
        _invoiceNotes = "";
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        _selectAll = (bool)e.Value!;
        if (_parsedInvoice != null)
        {
            foreach (var item in _parsedInvoice.Items)
            {
                item.Selected = _selectAll;
            }
        }
    }

    private async Task CreateFromParsed()
    {
        if (_parsedInvoice?.Metadata == null) return;

        _isCreating = true;
        _createError = null;

        // Validate that all selected items have a product match
        var selectedItems = _parsedInvoice.Items.Where((item, index) => item.Selected).ToList();
        var unmatchedItems = selectedItems.Where((item, index) => {
            var idx = _parsedInvoice.Items.IndexOf(item);
            return !_selectedProductIds.ContainsKey(idx) || !_selectedProductIds[idx].HasValue;
        }).ToList();
        
        if (unmatchedItems.Any())
        {
            _createError = $"Cannot create invoice: {unmatchedItems.Count} item(s) have no product match. Please match all items before saving.";
            _isCreating = false;
            return;
        }
        
        if (_paidByUserId == 0)
        {
            _createError = "Please select who paid this invoice.";
            _isCreating = false;
            return;
        }

        try
        {
            var dto = new CreateInvoiceFromParsedDto
            {
                InvoiceNumber = _parsedInvoice.Metadata.InvoiceNumber ?? "UNKNOWN",
                InvoiceDate = DateTime.Parse(_parsedInvoiceDate),
                Supplier = _parsedInvoice.Metadata.Supplier ?? "Unknown",
                AdditionalCosts = _additionalCosts,
                PriceReduction = _priceReduction,
                PaidByUserId = _paidByUserId,
                Notes = _invoiceNotes,
                SelectedItems = _parsedInvoice.Items
            };

            var response = await Http.PostAsJsonAsync("api/invoices/from-parsed", dto);
            
            if (response.IsSuccessStatusCode)
            {
                var created = await response.Content.ReadFromJsonAsync<InvoiceDto>();
                CloseParsedModal();
                await LoadInvoices();
                if (created != null)
                {
                    ViewInvoice(created.Id);
                }
            }
            else
            {
                _createError = "Failed to create invoice";
            }
        }
        catch (Exception ex)
        {
            _createError = $"Error: {ex.Message}";
        }
        finally
        {
            _isCreating = false;
        }
    }

    private void ViewInvoice(int id)
    {
        Navigation.NavigateTo($"/admin/invoices/{id}");
    }

    private async Task DeleteInvoice(int id)
    {
        if (!confirm("Are you sure you want to delete this invoice?"))
            return;

        try
        {
            await Http.DeleteAsync($"api/invoices/{id}");
            await LoadInvoices();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete invoice: {ex.Message}";
        }
    }

    private bool confirm(string message)
    {
        // In a real app, use a proper confirmation dialog
        return true;
    }
    
    // Product matching helpers
    private void ToggleSearch(int itemIndex)
    {
        _showingSearch[itemIndex] = !(_showingSearch.ContainsKey(itemIndex) && _showingSearch[itemIndex]);
        if (_showingSearch[itemIndex])
        {
            SearchProducts(itemIndex, _searchTerms.ContainsKey(itemIndex) ? _searchTerms[itemIndex] : "");
        }
    }
    
    private void SearchProducts(int itemIndex, string searchTerm)
    {
        _searchTerms[itemIndex] = searchTerm;
        if (string.IsNullOrWhiteSpace(searchTerm) || _allProducts == null)
        {
            _itemSuggestions[itemIndex] = new List<ProductDto>();
            return;
        }
        
        var term = searchTerm.ToLower();
        _itemSuggestions[itemIndex] = _allProducts
            .Where(p => p.Name.ToLower().Contains(term))
            .Take(10)
            .ToList();
    }
    
    private void SelectProduct(int itemIndex, int productId)
    {
        _selectedProductIds[itemIndex] = productId;
        _showingSearch[itemIndex] = false;
        
        // Update the item's matched product info
        if (_parsedInvoice != null && itemIndex < _parsedInvoice.Items.Count)
        {
            var item = _parsedInvoice.Items[itemIndex];
            var product = _allProducts?.FirstOrDefault(p => p.Id == productId);
            if (product != null)
            {
                item.MatchedProductId = productId;
                item.MatchedProductName = product.Name;
                item.MatchType = "Manual";
                item.MatchConfidence = 1.0m;
            }
        }
    }
    
    private string? GetSelectedProductName(int itemIndex)
    {
        if (_selectedProductIds.ContainsKey(itemIndex) && _selectedProductIds[itemIndex].HasValue)
        {
            var productId = _selectedProductIds[itemIndex]!.Value;
            return _allProducts?.FirstOrDefault(p => p.Id == productId)?.Name;
        }
        return null;
    }
    
    private decimal CalculateGrandTotal()
    {
        if (_parsedInvoice == null) return 0;
        
        var selectedItemsTotal = _parsedInvoice.Items
            .Where(i => i.Selected)
            .Sum(i => i.TotalPrice);
        
        return selectedItemsTotal + _additionalCosts - _priceReduction;
    }
}
