@page "/admin/products/{ProductId:int}"
@using Snackbox.Api.Dtos
@using Snackbox.ApiClient
@using Snackbox.Components.Components.Shared
@using Refit
@inject IProductsApi ProductsApi
@inject IShelvingActionsApi ShelvingActionsApi
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Product Details - Snackbox Admin</PageTitle>

<div class="container-fluid">
    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading product details...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
        <button class="btn btn-secondary" @onclick="NavigateBack">Back to Products</button>
    }
    else if (_productStock != null)
    {
        <div class="page-header">
            <div>
                <h2>@_productStock.ProductName</h2>
            </div>
            <button class="btn btn-secondary" @onclick="NavigateBack">Back to Products</button>
        </div>

        <div class="barcodes-section">
            <h3>Barcodes</h3>
            <div class="barcodes-list">
                @foreach (var barcode in _productStock.Barcodes)
                {
                    <div class="barcode-item">
                        <code class="barcode-code">@barcode.Barcode</code>
                        <span class="barcode-quantity">Qty: @barcode.Quantity</span>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveBarcode(barcode.Id)">
                            <span class="icon">üóëÔ∏è</span>
                        </button>
                    </div>
                }
                <button class="btn btn-sm btn-outline-primary" @onclick="ShowAddBarcodeModal">
                    <span class="icon">+</span> Add Barcode
                </button>
            </div>
        </div>

        <div class="stock-summary">
            <div class="summary-card">
                <div class="summary-label">In Storage</div>
                <div class="summary-value">@_productStock.TotalInStorage</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">On Shelf</div>
                <div class="summary-value">@_productStock.TotalOnShelf</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total Stock</div>
                <div class="summary-value">@(_productStock.TotalInStorage + _productStock.TotalOnShelf)</div>
            </div>
        </div>

        <div class="quick-actions-section">
            <h3>Quick Actions</h3>
            <div class="quick-actions-grid">
                <!-- Add to Storage -->
                <div class="action-card">
                    <h4>Add to Storage</h4>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="form-control" @bind="_addToStorageQuantity" min="1" />
                    </div>
                    <div class="form-group">
                        <label>Best Before Date</label>
                        <input type="date" class="form-control" @bind="_addToStorageBestBefore" />
                    </div>
                    <button class="btn btn-primary" @onclick="ExecuteAddToStorage" disabled="@_isProcessing">
                        @if (_isProcessing && _currentAction == "addToStorage")
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Add to Storage
                    </button>
                </div>

                <!-- Add to Shelf -->
                <div class="action-card">
                    <h4>Add to Shelf</h4>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="form-control" @bind="_addToShelfQuantity" min="1" />
                    </div>
                    <div class="form-group">
                        <label>Best Before Date</label>
                        <input type="date" class="form-control" @bind="_addToShelfBestBefore" />
                    </div>
                    <button class="btn btn-success" @onclick="ExecuteAddToShelf" disabled="@_isProcessing">
                        @if (_isProcessing && _currentAction == "addToShelf")
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Add to Shelf
                    </button>
                </div>

                <!-- Move from Storage to Shelf -->
                <div class="action-card">
                    <h4>Move Stock to Shelf</h4>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="form-control" @bind="_moveToShelfQuantity" min="1" />
                    </div>
                    <div class="form-group">
                        <label>Best Before Date</label>
                        <select class="form-control" @bind="_moveToShelfBatchId">
                            <option value="0">Select batch...</option>
                            @foreach (var batch in _productStock.Batches.Where(b => b.QuantityInStorage > 0).OrderBy(b => b.BestBeforeDate))
                            {
                                <option value="@batch.BatchId">
                                    @batch.BestBeforeDate.ToString("yyyy-MM-dd") (Available: @batch.QuantityInStorage)
                                </option>
                            }
                        </select>
                    </div>
                    <button class="btn btn-info" @onclick="ExecuteMoveToShelf" disabled="@_isProcessing">
                        @if (_isProcessing && _currentAction == "moveToShelf")
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Move to Shelf
                    </button>
                </div>
            </div>

            @if (_actionSuccess != null)
            {
                <div class="alert alert-success mt-3">@_actionSuccess</div>
            }
            @if (_actionError != null)
            {
                <div class="alert alert-danger mt-3">@_actionError</div>
            }
        </div>

        <div class="tabs">
            <button class="tab-button @(_activeTab == "batches" ? "active" : "")" @onclick='() => _activeTab = "batches"'>
                Stock by Batch
            </button>
            <button class="tab-button @(_activeTab == "actions" ? "active" : "")" @onclick="ActivateActionsTab">
                Shelving History
            </button>
        </div>

        <div class="tab-content">
            @if (_activeTab == "batches")
            {
                @if (_productStock.Batches.Any())
                {
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Best Before Date</th>
                                    <th>In Storage</th>
                                    <th>On Shelf</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var batch in _productStock.Batches.OrderBy(b => b.BestBeforeDate))
                                {
                                    <tr class="@(batch.BestBeforeDate < DateTime.UtcNow ? "expired" : batch.BestBeforeDate < DateTime.UtcNow.AddDays(30) ? "expiring-soon" : "")">
                                        <td>
                                            @batch.BestBeforeDate.ToString("yyyy-MM-dd")
                                            @if (batch.BestBeforeDate < DateTime.UtcNow)
                                            {
                                                <span class="badge badge-danger">Expired</span>
                                            }
                                            else if (batch.BestBeforeDate < DateTime.UtcNow.AddDays(30))
                                            {
                                                <span class="badge badge-warning">Expiring Soon</span>
                                            }
                                        </td>
                                        <td>@batch.QuantityInStorage</td>
                                        <td>@batch.QuantityOnShelf</td>
                                        <td>@(batch.QuantityInStorage + batch.QuantityOnShelf)</td>
                                        <td>
                                            @if (batch.QuantityInStorage > 0)
                                            {
                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowMoveToShelf(batch)">
                                                    Move to Shelf
                                                </button>
                                            }
                                            @if (batch.QuantityOnShelf > 0)
                                            {
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ShowMoveToStorage(batch)">
                                                    Move to Storage
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No batches found for this product.</p>
                    </div>
                }
            }
            else if (_activeTab == "actions")
            {
                @if (_shelvingActions == null)
                {
                    <div class="loading-container">
                        <div class="spinner-border spinner-border-sm"></div>
                        <span>Loading shelving history...</span>
                    </div>
                }
                else if (_shelvingActions.Any())
                {
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Action</th>
                                    <th>Quantity</th>
                                    <th>Batch (Best Before)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var action in _shelvingActions)
                                {
                                    <tr>
                                        <td>@action.ActionAt.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td><span class="badge badge-@GetActionBadgeClass(action.Type)">@FormatActionType(action.Type)</span></td>
                                        <td>@action.Quantity</td>
                                        <td>@action.BestBeforeDate.ToString("yyyy-MM-dd")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No shelving actions recorded yet.</p>
                    </div>
                }
            }
        </div>
    }
</div>

@if (_showMoveModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(_moveToShelf ? "Move to Shelf" : "Move to Storage")</h3>
                <button class="btn-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (_modalError != null)
                {
                    <div class="alert alert-danger">@_modalError</div>
                }
                <p>
                    Moving from batch with best before date: <strong>@_selectedBatch?.BestBeforeDate.ToString("yyyy-MM-dd")</strong>
                </p>
                <p>
                    Available: <strong>@(_moveToShelf ? _selectedBatch?.QuantityInStorage : _selectedBatch?.QuantityOnShelf)</strong>
                </p>
                <div class="form-group">
                    <label>Quantity to move</label>
                    <input type="number" class="form-control" @bind="_moveQuantity" @bind:event="oninput" min="0"
                           max="@(_moveToShelf ? _selectedBatch?.QuantityInStorage : _selectedBatch?.QuantityOnShelf)" />
                </div>
                <div class="quick-actions">
                    <label>Quick adjust:</label>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(-10)">-10</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(-5)">-5</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(-1)">-1</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(1)">+1</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(5)">+5</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => AdjustMoveQuantity(10)">+10</button>
                    </div>
                </div>
                @if (GetBarcodeQuantities().Any())
                {
                    <div class="barcode-quantities mt-3">
                        <label>Set to barcode quantity:</label>
                        <div class="btn-group" role="group">
                            @foreach (var qty in GetBarcodeQuantities())
                            {
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => _moveQuantity = qty">@qty</button>
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="ExecuteMove" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    Move
                </button>
            </div>
        </div>
    </div>
}

@if (_showAddBarcodeModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Barcode</h3>
                <button class="btn-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (_modalError != null)
                {
                    <div class="alert alert-danger">@_modalError</div>
                }
                <div class="form-group">
                    <label>Barcode</label>
                    <BarcodeInput @bind-Value="_newBarcodeCode" Placeholder="Enter or scan barcode..." />
                </div>
                <div class="form-group">
                    <label>Quantity per Unit</label>
                    <input type="number" class="form-control" @bind="_newBarcodeQuantity" min="1" />
                    <small class="text-muted">How many units this barcode represents (e.g., 12 for a box)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="SaveNewBarcode" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    Add Barcode
                </button>
            </div>
        </div>
    </div>
}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
    }

    .stock-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .summary-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .summary-value {
        font-size: 2rem;
        font-weight: 600;
        color: #007bff;
    }

    .barcodes-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .barcodes-section h3 {
        margin-top: 0;
        margin-bottom: 1rem;
    }

    .barcodes-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .barcode-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .barcode-item.inactive {
        opacity: 0.6;
        border-style: dashed;
    }

    .barcode-code {
        font-weight: 600;
        background: white;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
    }

    .barcode-quantity {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .badge-inactive {
        background-color: #6c757d;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.75rem;
    }

    .description-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .quick-actions-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .quick-actions-section h3 {
        margin-bottom: 1.5rem;
        color: #495057;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .action-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .action-card h4 {
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: #495057;
    }

    .btn-info {
        background-color: #17a2b8;
        color: white;
    }

    .mt-3 {
        margin-top: 1rem;
    }

    .tabs {
        display: flex;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 0;
        background: white;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
    }

    .tab-button {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s;
    }

    .tab-button:hover {
        background: #f8f9fa;
        color: #007bff;
    }

    .tab-button.active {
        color: #007bff;
        border-bottom-color: #007bff;
        background: #f8f9fa;
    }

    .tab-content {
        background: white;
        padding: 1.5rem;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table-container {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }

    .table th {
        background-color: #f8f9fa;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }

    .table tr.expired {
        background-color: #fff5f5;
    }

    .table tr.expiring-soon {
        background-color: #fffbeb;
    }

    .badge {
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        font-size: 0.75em;
        font-weight: 500;
        margin-left: 0.5rem;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-info {
        background-color: #17a2b8;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    .loading-container {
        text-align: center;
        padding: 2rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        max-width: 400px;
        width: 90%;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-outline-primary {
        background-color: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }

    .btn-outline-secondary {
        background-color: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }

    code {
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
    }

    .text-muted {
        color: #6c757d;
    }

    .quick-actions,
    .barcode-quantities {
        margin-top: 1rem;
    }

    .quick-actions label,
    .barcode-quantities label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
</style>

@code {
    [Parameter]
    public int ProductId { get; set; }

    private ProductStockDto? _productStock;
    private List<ShelvingActionDto>? _shelvingActions;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string _activeTab = "batches";

    private bool _showMoveModal;
    private bool _showAddBarcodeModal;
    private BatchStockInfo? _selectedBatch;
    private bool _moveToShelf = true;
    private int _moveQuantity = 1;
    private string? _modalError;
    private bool _isSaving;

    // Barcode management
    private string _newBarcodeCode = string.Empty;
    private int _newBarcodeQuantity = 1;

    // Quick actions properties
    private int _addToStorageQuantity = 1;
    private DateTime _addToStorageBestBefore = DateTime.Today.AddMonths(6);
    private int _addToShelfQuantity = 1;
    private DateTime _addToShelfBestBefore = DateTime.Today.AddMonths(6);
    private int _moveToShelfQuantity = 1;
    private int _moveToShelfBatchId;
    private bool _isProcessing;
    private string? _currentAction;
    private string? _actionSuccess;
    private string? _actionError;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductStock();
    }

    private async Task LoadProductStock()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _productStock = await ProductsApi.GetProductStockAsync(ProductId);
        }
        catch (ApiException ex)
        {
            _errorMessage = $"Failed to load product: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load product: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadShelvingActions()
    {
        if (_shelvingActions != null) return;

        try
        {
            var result = await ShelvingActionsApi.GetAllAsync(productId: ProductId);
            _shelvingActions = result.ToList();
        }
        catch (ApiException ex)
        {
            _errorMessage = $"Failed to load shelving actions: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load shelving actions: {ex.Message}";
        }
    }

    private async Task ActivateActionsTab()
    {
        _activeTab = "actions";
        await LoadShelvingActions();
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/admin/products");
    }

    private void ShowMoveToShelf(BatchStockInfo batch)
    {
        _selectedBatch = batch;
        _moveToShelf = true;
        // Prefill with current storage quantity
        _moveQuantity = batch.QuantityInStorage > 0 ? batch.QuantityInStorage : 1;
        _modalError = null;
        _showMoveModal = true;
    }

    private void ShowMoveToStorage(BatchStockInfo batch)
    {
        _selectedBatch = batch;
        _moveToShelf = false;
        // Prefill with current shelf quantity
        _moveQuantity = batch.QuantityOnShelf > 0 ? batch.QuantityOnShelf : 1;
        _modalError = null;
        _showMoveModal = true;
    }

    private void AdjustMoveQuantity(int delta)
    {
        var maxQuantity = _moveToShelf ? (_selectedBatch?.QuantityInStorage ?? 0) : (_selectedBatch?.QuantityOnShelf ?? 0);
        _moveQuantity = Math.Max(0, Math.Min(_moveQuantity + delta, maxQuantity));
    }

    private IEnumerable<int> GetBarcodeQuantities()
    {
        if (_productStock?.Barcodes == null) return Enumerable.Empty<int>();
        
        return _productStock.Barcodes
            .Select(b => b.Quantity)
            .Where(q => q > 0)
            .Distinct()
            .OrderBy(q => q);
    }

    private async Task ExecuteMove()
    {
        if (_selectedBatch == null) return;

        _isSaving = true;
        _modalError = null;

        try
        {
            var endpoint = _moveToShelf ? "move-to-shelf" : "move-to-storage";
            var response = await Http.PostAsJsonAsync($"api/productbatches/{_selectedBatch.BatchId}/{endpoint}", new
            {
                quantity = _moveQuantity
            });

            if (response.IsSuccessStatusCode)
            {
                CloseModal();
                _shelvingActions = null;
                await LoadProductStock();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                _modalError = error?.Message ?? "Failed to move stock. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void CloseModal()
    {
        _showMoveModal = false;
        _showAddBarcodeModal = false;
        _selectedBatch = null;
        _moveQuantity = 1;
        _modalError = null;
        _newBarcodeCode = string.Empty;
        _newBarcodeQuantity = 1;
    }

    private void ShowAddBarcodeModal()
    {
        _newBarcodeCode = string.Empty;
        _newBarcodeQuantity = 1;
        _modalError = null;
        _showAddBarcodeModal = true;
    }


    private async Task RemoveBarcode(int barcodeId)
    {
            _isSaving = true;
            _modalError = null;

            try
            {
                await ProductsApi.DeleteBarcodeAsync(ProductId, barcodeId);
                await LoadProductStock();
            }
            catch (ApiException ex)
            {
                _modalError = $"Failed to remove barcode: {ex.Content ?? ex.Message}";
            }
            catch (Exception ex)
            {
                _modalError = $"Error: {ex.Message}";
            }
            finally
            {
                _isSaving = false;
            }
    }

    private async Task SaveNewBarcode()
    {
        if (string.IsNullOrWhiteSpace(_newBarcodeCode) || _newBarcodeQuantity <= 0 || _productStock == null)
        {
            _modalError = "Please enter a valid barcode and quantity.";
            return;
        }

        _isSaving = true;
        _modalError = null;

        try
        {
            var dto = new CreateProductBarcodeDto
            {
                Barcode = _newBarcodeCode,
                Quantity = _newBarcodeQuantity
            };
            await ProductsApi.AddBarcodeAsync(ProductId, dto);
            await LoadProductStock();
            CloseModal();
        }
        catch (ApiException ex)
        {
            _modalError = $"Failed to add barcode: {ex.Content ?? ex.Message}";
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ExecuteAddToStorage()
    {
        if (_addToStorageQuantity <= 0 || _productStock == null) return;

        _isProcessing = true;
        _currentAction = "addToStorage";
        _actionSuccess = null;
        _actionError = null;

        try
        {
            // Find or create batch
            var batch = _productStock.Batches.FirstOrDefault(b => b.BestBeforeDate.Date == _addToStorageBestBefore.Date);
            int batchId;

            if (batch == null)
            {
                // Create new batch first
                var createBatchResponse = await Http.PostAsJsonAsync("api/productbatches", new
                {
                    productId = ProductId,
                    bestBeforeDate = _addToStorageBestBefore.Date,
                    initialQuantity = 0
                });

                if (!createBatchResponse.IsSuccessStatusCode)
                {
                    _actionError = "Failed to create batch. Please try again.";
                    return;
                }

                var createdBatch = await createBatchResponse.Content.ReadFromJsonAsync<ProductBatchDto>();
                batchId = createdBatch!.Id;
            }
            else
            {
                batchId = batch.BatchId;
            }

            // Add to storage
            var response = await Http.PostAsJsonAsync($"api/productbatches/{batchId}/add-to-storage", new
            {
                quantity = _addToStorageQuantity
            });

            if (response.IsSuccessStatusCode)
            {
                _actionSuccess = $"Successfully added {_addToStorageQuantity} items to storage";
                _addToStorageQuantity = 1;
                await LoadProductStock();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                _actionError = error?.Message ?? "Failed to add to storage. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _actionError = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            _currentAction = null;
        }
    }

    private async Task ExecuteAddToShelf()
    {
        if (_addToShelfQuantity <= 0 || _productStock == null) return;

        _isProcessing = true;
        _currentAction = "addToShelf";
        _actionSuccess = null;
        _actionError = null;

        try
        {
            // Find or create batch
            var batch = _productStock.Batches.FirstOrDefault(b => b.BestBeforeDate.Date == _addToShelfBestBefore.Date);
            int batchId;

            if (batch == null)
            {
                // Create new batch first
                var createBatchResponse = await Http.PostAsJsonAsync("api/productbatches", new
                {
                    productId = ProductId,
                    bestBeforeDate = _addToShelfBestBefore.Date,
                    initialQuantity = 0
                });

                if (!createBatchResponse.IsSuccessStatusCode)
                {
                    _actionError = "Failed to create batch. Please try again.";
                    return;
                }

                var createdBatch = await createBatchResponse.Content.ReadFromJsonAsync<ProductBatchDto>();
                batchId = createdBatch!.Id;
            }
            else
            {
                batchId = batch.BatchId;
            }

            // Add to shelf
            var response = await Http.PostAsJsonAsync($"api/productbatches/{batchId}/add-to-shelf", new
            {
                quantity = _addToShelfQuantity
            });

            if (response.IsSuccessStatusCode)
            {
                _actionSuccess = $"Successfully added {_addToShelfQuantity} items to shelf";
                _addToShelfQuantity = 1;
                await LoadProductStock();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                _actionError = error?.Message ?? "Failed to add to shelf. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _actionError = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            _currentAction = null;
        }
    }

    private async Task ExecuteMoveToShelf()
    {
        if (_moveToShelfQuantity <= 0 || _moveToShelfBatchId == 0 || _productStock == null) return;

        _isProcessing = true;
        _currentAction = "moveToShelf";
        _actionSuccess = null;
        _actionError = null;

        try
        {
            var response = await Http.PostAsJsonAsync($"api/productbatches/{_moveToShelfBatchId}/move-to-shelf", new
            {
                quantity = _moveToShelfQuantity
            });

            if (response.IsSuccessStatusCode)
            {
                _actionSuccess = $"Successfully moved {_moveToShelfQuantity} items to shelf";
                _moveToShelfQuantity = 1;
                _moveToShelfBatchId = 0;
                await LoadProductStock();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                _actionError = error?.Message ?? "Failed to move to shelf. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _actionError = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            _currentAction = null;
        }
    }

    private string FormatActionType(ShelvingActionType type) => type switch
    {
        ShelvingActionType.AddedToStorage => "Added to Storage",
        ShelvingActionType.MovedToShelf => "Moved to Shelf",
        ShelvingActionType.MovedFromShelf => "Moved from Shelf",
        ShelvingActionType.RemovedFromStorage => "Removed from Storage",
        ShelvingActionType.RemovedFromShelf => "Removed from Shelf",
        _ => type.ToString()
    };

    private string GetActionBadgeClass(ShelvingActionType type) => type switch
                                                                   {
                                                                       ShelvingActionType.AddedToStorage => "success",
                                                                       ShelvingActionType.MovedToShelf => "info",
                                                                       ShelvingActionType.MovedFromShelf => "warning",
                                                                       ShelvingActionType.RemovedFromStorage => "danger",
                                                                       ShelvingActionType.RemovedFromShelf => "danger",
                                                                       _ => "secondary"
                                                                   };


    private class ProductBatchDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public DateTime BestBeforeDate { get; set; }
        public int QuantityInStorage { get; set; }
        public int QuantityOnShelf { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }

}
