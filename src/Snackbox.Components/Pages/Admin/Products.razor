@page "/admin/products"
@using System.ComponentModel.DataAnnotations
@using Snackbox.Api.Dtos
@using Snackbox.ApiClient
@using Refit
@inject IProductsApi ProductsApi
@inject IShelvingActionsApi ShelvingActionsApi
@inject NavigationManager Navigation

<PageTitle>Product Management - Snackbox Admin</PageTitle>

<div class="container-fluid">
    <div class="page-header">
        <h2>Product Management</h2>
        <div class="header-buttons">
            <button class="btn btn-secondary" @onclick="ShowBarcodeLookup">
                <i class="bi bi-search icon" aria-hidden="true"></i> Lookup Barcode
            </button>
            <button class="btn btn-primary" @onclick="ShowCreateProduct">
                <span class="icon">+</span> Add Product
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-bar">
        <input type="text" class="form-control search-input" placeholder="Search products..."
               @bind="_searchTerm" @bind:event="oninput" @onkeyup="FilterProducts" />
        <select class="form-control sort-select" @bind="_sortBy" @bind:after="SortProducts">
            <option value="name">Sort by Name</option>
            <option value="price">Sort by Price</option>
            <option value="created">Sort by Created Date</option>
        </select>
        <button class="btn @(_batchMode ? "btn-primary" : "btn-outline-primary")" @onclick="ToggleBatchMode">
            @(_batchMode ? "Exit Batch Mode" : "Batch Scan Mode")
        </button>
    </div>

    @if (_batchMode)
    {
        <div class="batch-mode-section">
            <div class="batch-controls">
                <div class="control-group">
                    <label>Action Type</label>
                    <select class="form-control" @bind="_batchActionType">
                        <option value="AddedToStorage">Add to Storage</option>
                        <option value="AddedToShelf">Add Directly to Shelf</option>
                        <option value="MovedToShelf">Move Stock to Shelf</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Scan Barcode</label>
                    <input type="text" class="form-control" @bind="_batchBarcode" @bind:event="oninput"
                           @onkeyup="HandleBatchBarcodeInput" placeholder="Scan or enter barcode..." autofocus />
                </div>
            </div>

            @if (_batchScannedItems.Any())
            {
                <div class="batch-items">
                    <div class="batch-header">
                        <h4>Scanned Items (@_batchScannedItems.Count)</h4>
                        <div class="batch-actions">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="ClearBatchItems">Clear All</button>
                            <button class="btn btn-primary btn-sm" @onclick="ProcessBatchItems" disabled="@_isBatchProcessing">
                                @if (_isBatchProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                Process (@_batchScannedItems.Count)
                            </button>
                        </div>
                    </div>

                    @if (_batchError != null)
                    {
                        <div class="alert alert-danger">@_batchError</div>
                    }
                    @if (_batchSuccess != null)
                    {
                        <div class="alert alert-success">@_batchSuccess</div>
                    }

                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Barcode</th>
                                <th>Quantity</th>
                                <th>Best Before</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _batchScannedItems)
                            {
                                <tr>
                                    <td>@item.ProductName</td>
                                    <td><code>@item.Barcode</code></td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" style="width: 80px;"
                                               @bind="item.Quantity" min="1" />
                                    </td>
                                    <td>
                                        @if (item.ActionType == "MovedToShelf" && item.AvailableDates.Any())
                                        {
                                            <select class="form-control form-control-sm" @bind="item.SelectedDate">
                                                @foreach (var date in item.AvailableDates)
                                                {
                                                    <option value="@date.ToString("yyyy-MM-dd")">@date.ToString("yyyy-MM-dd")</option>
                                                }
                                            </select>
                                        }
                                        else if (item.ActionType == "MovedToShelf")
                                        {
                                            <span class="text-muted">No stock</span>
                                        }
                                        else
                                        {
                                            <input type="date" class="form-control form-control-sm" value="@item.BestBeforeDate"
                                                   @onchange="@(e => item.BestBeforeDate = e.Value?.ToString() ?? "")" />
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveBatchItem(item)">Remove</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }

    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading products...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }
    else if (_filteredProducts != null && _filteredProducts.Any())
    {
        <div class="table-container">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Best before in Stock</th>
                        <th>Best before on Shelf</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var product in _filteredProducts)
                    {
                        <tr @onclick="() => NavigateToProductDetail(product.Id)" style="cursor: pointer;">
                            <td>@product.Name</td>
                            <td>@(product.BestBeforeInStock?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td>@(product.BestBeforeOnShelf?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" @onclick:stopPropagation="true" @onclick="() => ShowEditProduct(product)">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick:stopPropagation="true" @onclick="() => ConfirmDelete(product)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="empty-state">
            <p>No products found.</p>
            <button class="btn btn-primary" @onclick="ShowCreateProduct">Add Your First Product</button>
        </div>
    }
</div>

@if (_showCreateEditModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(_editingProduct == null ? "Create Product" : "Edit Product")</h3>
                <button class="btn-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (_modalError != null)
                {
                    <div class="alert alert-danger">@_modalError</div>
                }
                <EditForm Model="@_productForm" OnValidSubmit="@SaveProduct">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Product Name</label>
                        <InputText @bind-Value="_productForm.Name" class="form-control" />
                        <ValidationMessage For="@(() => _productForm.Name)" />
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            Save
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if (_showDeleteModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="btn-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (_modalError != null)
                {
                    <div class="alert alert-danger">@_modalError</div>
                }
                <p>Are you sure you want to delete the product "<strong>@_productToDelete?.Name</strong>"?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="DeleteProduct" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    Delete
                </button>
            </div>
        </div>
    </div>
}

<BarcodeLookupModal IsVisible="@_showBarcodeLookupModal"
                    OnClose="@CloseBarcodeLookup"
                    OnProductCreated="@OnProductCreatedFromLookup" />

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .header-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-input {
        flex: 1;
        max-width: 400px;
    }

    .sort-select {
        width: auto;
    }

    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        padding: 0.75rem;
        text-align: left;
    }

    .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }

    .loading-container {
        text-align: center;
        padding: 3rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        max-width: 500px;
        width: 90%;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-outline-primary {
        background-color: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }

    .btn-outline-secondary {
        background-color: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-outline-danger {
        background-color: transparent;
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }

    code {
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
    }

    .text-muted {
        color: #6c757d;
    }

    .batch-mode-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .batch-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .control-group {
        flex: 1;
        min-width: 200px;
    }

    .control-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .batch-items {
        margin-top: 1.5rem;
    }

    .batch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .batch-header h4 {
        margin: 0;
    }

    .batch-actions {
        display: flex;
        gap: 0.5rem;
    }

    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
</style>

@code {
    private List<ProductDto>? _products;
    private List<ProductDto>? _filteredProducts;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string _searchTerm = "";
    private string _sortBy = "name";

    private bool _showCreateEditModal;
    private bool _showDeleteModal;
    private bool _showBarcodeLookupModal;
    private ProductDto? _editingProduct;
    private ProductDto? _productToDelete;
    private ProductFormModel _productForm = new();
    private string? _modalError;
    private bool _isSaving;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await ProductsApi.GetAllAsync();
            _products = result.ToList();
            FilterProducts();
        }
        catch (ApiException ex)
        {
            _errorMessage = $"Failed to load products: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load products: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterProducts()
    {
        if (_products == null) return;

        _filteredProducts = _products
            .Where(p => string.IsNullOrEmpty(_searchTerm) ||
                        p.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();

        SortProducts();
    }

    private void SortProducts()
    {
        if (_filteredProducts == null) return;

        _filteredProducts = _sortBy switch
        {
            "name" => _filteredProducts.OrderBy(p => p.Name).ToList(),
            "created" => _filteredProducts.OrderByDescending(p => p.CreatedAt).ToList(),
            _ => _filteredProducts
        };
    }

    private void NavigateToProductDetail(int productId)
    {
        Navigation.NavigateTo($"/admin/products/{productId}");
    }

    private void ShowCreateProduct()
    {
        _editingProduct = null;
        _productForm = new ProductFormModel();
        _modalError = null;
        _showCreateEditModal = true;
    }

    private void ShowEditProduct(ProductDto product)
    {
        _editingProduct = product;
        _productForm = new ProductFormModel
        {
            Name = product.Name,
        };
        _modalError = null;
        _showCreateEditModal = true;
    }

    private void ConfirmDelete(ProductDto product)
    {
        _productToDelete = product;
        _modalError = null;
        _showDeleteModal = true;
    }

    private async Task SaveProduct()
    {
        _isSaving = true;
        _modalError = null;

        try
        {
            if (_editingProduct == null)
            {
                var createDto = new CreateProductDto
                {
                    Name = _productForm.Name,
                };
                await ProductsApi.CreateAsync(createDto);
            }
            else
            {
                var updateDto = new UpdateProductDto
                {
                    Name = _productForm.Name,
                };
                await ProductsApi.UpdateAsync(_editingProduct.Id, updateDto);
            }

            CloseModal();
            await LoadProducts();
        }
        catch (ApiException ex)
        {
            _modalError = ex.Content ?? "Failed to save product. Please try again.";
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteProduct()
    {
        if (_productToDelete == null) return;

        _isSaving = true;
        _modalError = null;

        try
        {
            await ProductsApi.DeleteAsync(_productToDelete.Id);
            CloseModal();
            await LoadProducts();
        }
        catch (ApiException ex)
        {
            _modalError = ex.Content ?? "Failed to delete product. Please try again.";
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void CloseModal()
    {
        _showCreateEditModal = false;
        _showDeleteModal = false;
        _editingProduct = null;
        _productToDelete = null;
        _productForm = new();
        _modalError = null;
    }

    // Batch mode state
    private bool _batchMode;
    private string _batchActionType = "AddedToStorage";
    private string _batchBarcode = string.Empty;
    private List<BatchScannedItem> _batchScannedItems = new();
    private bool _isBatchProcessing;
    private string? _batchError;
    private string? _batchSuccess;

    private void ShowBarcodeLookup()
    {
        _showBarcodeLookupModal = true;
    }

    private void CloseBarcodeLookup()
    {
        _showBarcodeLookupModal = false;
    }

    private async Task OnProductCreatedFromLookup()
    {
        await LoadProducts();
    }

    private void ToggleBatchMode()
    {
        _batchMode = !_batchMode;
        if (!_batchMode)
        {
            ClearBatchItems();
        }
    }

    private async Task HandleBatchBarcodeInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_batchBarcode))
        {
            await LookupAndAddBatchProduct(_batchBarcode.Trim());
            _batchBarcode = string.Empty;
        }
    }

    private async Task LookupAndAddBatchProduct(string barcode)
    {
        _batchError = null;
        _batchSuccess = null;

        try
        {
            // Get product by barcode
            var product = await ProductsApi.GetByBarcodeAsync(barcode);
            if (product == null)
            {
                _batchError = $"Product with barcode '{barcode}' not found.";
                return;
            }

            // Get barcode quantity
            int barcodeQuantity = 1;
            var scannedBarcode = product.Barcodes.FirstOrDefault(b => b.Barcode == barcode);
            if (scannedBarcode != null)
            {
                barcodeQuantity = scannedBarcode.Quantity;
            }

            // Get stock information
            var stock = await ProductsApi.GetProductStockAsync(product.Id);

            var item = new BatchScannedItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                Barcode = barcode,
                Quantity = barcodeQuantity,
                ActionType = _batchActionType,
                BestBeforeDate = DateTime.Today.AddDays(30).ToString("yyyy-MM-dd")
            };

            // For MovedToShelf, populate available dates with storage stock
            if (_batchActionType == "MovedToShelf")
            {
                item.AvailableDates = stock.Batches
                    .Where(b => b.QuantityInStorage > 0)
                    .Select(b => b.BestBeforeDate)
                    .OrderBy(d => d)
                    .ToList();

                if (item.AvailableDates.Any())
                {
                    item.SelectedDate = item.AvailableDates.First().ToString("yyyy-MM-dd");
                }
            }

            _batchScannedItems.Add(item);
        }
        catch (ApiException)
        {
            _batchError = $"Product with barcode '{barcode}' not found.";
        }
        catch (Exception ex)
        {
            _batchError = $"Error looking up product: {ex.Message}";
        }
    }

    private void RemoveBatchItem(BatchScannedItem item)
    {
        _batchScannedItems.Remove(item);
    }

    private void ClearBatchItems()
    {
        _batchScannedItems.Clear();
        _batchError = null;
        _batchSuccess = null;
    }

    private async Task ProcessBatchItems()
    {
        if (!_batchScannedItems.Any()) return;

        _isBatchProcessing = true;
        _batchError = null;
        _batchSuccess = null;

        try
        {
            var actions = new List<CreateShelvingActionDto>();

            foreach (var item in _batchScannedItems)
            {
                // Determine the best before date to use
                string bestBeforeDate;
                if (item.ActionType == "MovedToShelf")
                {
                    bestBeforeDate = item.SelectedDate ?? item.BestBeforeDate;
                }
                else
                {
                    bestBeforeDate = item.BestBeforeDate;
                }

                if (!DateTime.TryParse(bestBeforeDate, out var parsedDate))
                {
                    _batchError = $"Invalid date format for product '{item.Barcode}': {bestBeforeDate}";
                    return;
                }

                actions.Add(new CreateShelvingActionDto
                {
                    ProductBarcode = item.Barcode,
                    Quantity = item.Quantity,
                    BestBeforeDate = parsedDate,
                    Type = Enum.Parse<ShelvingActionType>(item.ActionType)
                });
            }

            var request = new BatchShelvingRequest { Actions = actions };
            var result = await ShelvingActionsApi.CreateBatchAsync(request);

            if (result.Success)
            {
                _batchSuccess = $"Successfully processed {_batchScannedItems.Count} items.";
                _batchScannedItems.Clear();
                await LoadProducts(); // Refresh product list
            }
            else
            {
                _batchError = string.Join(", ", result.Errors);
            }
        }
        catch (ApiException ex)
        {
            _batchError = ex.Content ?? "Failed to process batch items.";
        }
        catch (Exception ex)
        {
            _batchError = $"Error processing batch: {ex.Message}";
        }
        finally
        {
            _isBatchProcessing = false;
        }
    }

    private class BatchScannedItem
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public string Barcode { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public string ActionType { get; set; } = string.Empty;
        public string BestBeforeDate { get; set; } = string.Empty;
        public string? SelectedDate { get; set; }
        public List<DateTime> AvailableDates { get; set; } = new();
    }

    private class ProductFormModel
    {
        [Required(ErrorMessage = "Product name is required")]
        public string Name { get; set; } = string.Empty;
    }
}
