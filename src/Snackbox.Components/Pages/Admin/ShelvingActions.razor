@page "/admin/shelving-actions"
@using Snackbox.Api.Dtos
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Shelving Actions - Snackbox Admin</PageTitle>

<div class="container-fluid">
    <div class="page-header">
        <h2>Shelving Actions History</h2>
    </div>

    <!-- Filter Controls -->
    <div class="filter-bar">
        <div class="filter-group">
            <label>Filter by Action Type</label>
            <select class="form-control" @bind="_filterActionType" @bind:after="LoadActions">
                <option value="">All Actions</option>
                <option value="AddedToStorage">Added to Storage</option>
                <option value="MovedToShelf">Moved to Shelf</option>
                <option value="MovedFromShelf">Moved from Shelf</option>
                <option value="RemovedFromStorage">Removed from Storage</option>
                <option value="RemovedFromShelf">Removed from Shelf</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Search Product</label>
            <input type="text" class="form-control" placeholder="Search by name or barcode..."
                   @bind="_searchTerm" @bind:event="oninput" @onkeyup="FilterActions" />
        </div>
        <div class="filter-group">
            <label>Show</label>
            <select class="form-control" @bind="_pageSize" @bind:after="LoadActions">
                <option value="25">25 items</option>
                <option value="50">50 items</option>
                <option value="100">100 items</option>
                <option value="500">500 items</option>
            </select>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading shelving actions...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }
    else if (_filteredActions != null && _filteredActions.Any())
    {
        <div class="table-container">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Product</th>
                        <th>Barcode</th>
                        <th>Action</th>
                        <th>Quantity</th>
                        <th>Best Before</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var action in _filteredActions)
                    {
                        <tr>
                            <td>@action.ActionAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@action.ProductName</td>
                            <td><code>@action.ProductBarcode</code></td>
                            <td>
                                <span class="badge badge-@GetActionBadgeClass(action.Type)">
                                    @FormatActionType(action.Type)
                                </span>
                            </td>
                            <td>@action.Quantity</td>
                            <td>
                                @action.BestBeforeDate.ToString("yyyy-MM-dd")
                                @if (action.BestBeforeDate < DateTime.UtcNow)
                                {
                                    <span class="badge badge-danger">Expired</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => NavigateToProduct(action.ProductId)">
                                    View Product
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="empty-state">
            <p>No shelving actions found.</p>
        </div>
    }
</div>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .filter-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 500;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .filter-group .form-control {
        min-width: 200px;
    }

    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        padding: 0.75rem;
        text-align: left;
    }

    .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }

    .badge {
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        font-size: 0.75em;
        font-weight: 500;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-info {
        background-color: #17a2b8;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    .loading-container {
        text-align: center;
        padding: 3rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-outline-primary {
        background-color: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .form-control {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }

    code {
        background: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
    }
</style>

@code {
    private List<ShelvingActionDto>? _allActions;
    private List<ShelvingActionDto>? _filteredActions;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string _filterActionType = "";
    private string _searchTerm = "";
    private int _pageSize = 50;

    protected override async Task OnInitializedAsync()
    {
        await LoadActions();
    }

    private async Task LoadActions()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var url = $"api/shelvingactions?limit={_pageSize}";
            _allActions = await Http.GetFromJsonAsync<List<ShelvingActionDto>>(url);
            FilterActions();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load shelving actions: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterActions()
    {
        if (_allActions == null) return;

        _filteredActions = _allActions
            .Where(a => string.IsNullOrEmpty(_filterActionType) || a.Type.ToString() == _filterActionType)
            .Where(a => string.IsNullOrEmpty(_searchTerm) ||
                        a.ProductName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                        a.ProductBarcode.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void NavigateToProduct(int productId)
    {
        Navigation.NavigateTo($"/admin/products/{productId}");
    }

    private string FormatActionType(ShelvingActionType type) => type switch
    {
        ShelvingActionType.AddedToStorage    => "Added to Storage",
        ShelvingActionType.MovedToShelf  => "Moved to Shelf",
        ShelvingActionType.MovedFromShelf    => "Moved from Shelf",
        ShelvingActionType.RemovedFromStorage    => "Removed from Storage",
        ShelvingActionType.RemovedFromShelf  => "Removed from Shelf",
        _ => type.ToString()
    };

    private string GetActionBadgeClass(ShelvingActionType type) => type switch
                                                                   {
                                                                       ShelvingActionType.AddedToStorage => "success",
                                                                       ShelvingActionType.MovedToShelf => "info",
                                                                       ShelvingActionType.MovedFromShelf => "warning",
                                                                       ShelvingActionType.RemovedFromStorage => "danger",
                                                                       ShelvingActionType.RemovedFromShelf => "danger",
                                                                       _ => "secondary"
                                                                   };

}
