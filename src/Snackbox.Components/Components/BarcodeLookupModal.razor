@inject HttpClient Http

@if (IsVisible)
{
    @if (!isProductFound)
    {
        <div class="modal-backdrop" @onclick="Cancel"></div>
    }
    else
    {
        <div class="modal-backdrop"></div>
    }
    <div class="modal-dialog barcode-lookup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Lookup Product Barcode</h3>
                <button class="btn-close" @onclick="Cancel">&times;</button>
            </div>
            <div class="modal-body">
                @if (errorMessage != null)
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }

                @if (!isProductFound)
                {
                    <!-- Barcode Search Section -->
                    <div class="form-group">
                        <label>Barcode</label>
                        <div class="input-with-button">
                            <input type="text" 
                                   @bind="barcodeInput" 
                                   @bind:event="oninput"
                                   @onkeypress="HandleKeyPress"
                                   class="form-control" 
                                   placeholder="Enter barcode number"
                                   disabled="@isSearching" />
                            <button class="btn btn-primary" 
                                    @onclick="SearchBarcode" 
                                    disabled="@(isSearching || string.IsNullOrWhiteSpace(barcodeInput) || !IsBarcodeValid())">
                                @if (isSearching)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <span>Search</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Product Information Display -->
                    <div class="product-info-section">
                        <h4>Product Information</h4>
                        
                        <div class="info-field">
                            <label>Title:</label>
                            <span>@lookupResult?.Title</span>
                        </div>
                        
                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Manufacturer))
                        {
                            <div class="info-field">
                                <label>Manufacturer:</label>
                                <span>@lookupResult.Manufacturer</span>
                            </div>
                        }
                        
                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Brand))
                        {
                            <div class="info-field">
                                <label>Brand:</label>
                                <span>@lookupResult.Brand</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Category))
                        {
                            <div class="info-field">
                                <label>Category:</label>
                                <span>@lookupResult.Category</span>
                            </div>
                        }
                    </div>

                    <!-- Barcode Duplicate Check -->
                    @if (!string.IsNullOrWhiteSpace(existingProductWithBarcode))
                    {
                        <div class="alert alert-warning">
                            <strong>⚠ Warning:</strong> A product with this barcode already exists: <strong>@existingProductWithBarcode</strong>
                            <br/>Creating a new product will result in a duplicate barcode error.
                        </div>
                    }

                    <!-- Similar Products Section -->
                    @if (similarProducts != null && similarProducts.Any())
                    {
                        <div class="similar-products-section">
                            <h4>⚠ Potential Matches Found</h4>
                            <p class="text-muted">The following existing products may be similar. Consider using one of these instead of creating a duplicate:</p>
                            
                            <div class="similar-products-list">
                                @foreach (var similar in similarProducts)
                                {
                                    <div class="similar-product-item">
                                        <div class="similar-product-info">
                                            <strong>@similar.Name</strong>
                                            <div class="similar-product-details">
                                                <span class="badge">@similar.Barcode</span>
                                                <span>€@similar.Price.ToString("F2")</span>
                                                @if (!string.IsNullOrWhiteSpace(similar.Description))
                                                {
                                                    <span class="text-muted">@similar.Description</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="match-score">@similar.MatchScore% match</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Product Name Selection -->
                    <div class="form-group">
                        <label>Product Name</label>
                        
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="nameOption" value="title" 
                                       @onchange='() => SelectNameOption("title")' 
                                       checked="@(selectedNameOption == "title")" />
                                <span>@lookupResult?.Title</span>
                            </label>

                            @if (!string.IsNullOrWhiteSpace(lookupResult?.Manufacturer))
                            {
                                <label class="radio-option">
                                    <input type="radio" name="nameOption" value="manufacturer" 
                                           @onchange='() => SelectNameOption("manufacturer")' 
                                           checked="@(selectedNameOption == "manufacturer")" />
                                    <span>@lookupResult.Manufacturer - @lookupResult.Title</span>
                                </label>
                            }

                            @if (!string.IsNullOrWhiteSpace(lookupResult?.Brand))
                            {
                                <label class="radio-option">
                                    <input type="radio" name="nameOption" value="brand" 
                                           @onchange='() => SelectNameOption("brand")' 
                                           checked="@(selectedNameOption == "brand")" />
                                    <span>@lookupResult.Brand - @lookupResult.Title</span>
                                </label>
                            }

                            <label class="radio-option">
                                <input type="radio" name="nameOption" value="custom" 
                                       @onchange='() => SelectNameOption("custom")' 
                                       checked="@(selectedNameOption == "custom")" />
                                <span>Custom Name</span>
                            </label>
                        </div>

                        @if (selectedNameOption == "custom")
                        {
                            <input type="text" 
                                   @bind="customName" 
                                   @bind:event="oninput"
                                   class="form-control mt-2" 
                                   placeholder="Enter custom product name" />
                        }
                    </div>

                    <!-- Price Field -->
                    <div class="form-group">
                        <label>Price (€)</label>
                        <input type="number" 
                               @bind="productPrice" 
                               @bind:event="oninput"
                               class="form-control" 
                               step="0.01" 
                               min="0"
                               placeholder="0.00" />
                    </div>

                    <!-- Description Field -->
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea @bind="productDescription" 
                                  @bind:event="oninput"
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Enter product description"></textarea>
                    </div>
                }
            </div>
            
            <div class="modal-footer">
                @if (isProductFound)
                {
                    <button type="button" class="btn btn-secondary" @onclick="ResetSearch">Back to Search</button>
                }
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                @if (isProductFound)
                {
                    <button type="button" class="btn btn-primary" @onclick="SaveProduct" disabled="@(isSaving || !IsFormValid())">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Create Product
                    </button>
                }
            </div>
        </div>
    </div>
}

<style>
    .barcode-lookup-modal {
        max-width: 600px;
    }

    .input-with-button {
        display: flex;
        gap: 0.5rem;
    }

    .input-with-button .form-control {
        flex: 1;
    }

    .input-with-button .btn {
        white-space: nowrap;
    }

    .product-info-section {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .product-info-section h4 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .similar-products-section {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .similar-products-section h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
        color: #856404;
    }

    .similar-products-list {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .similar-product-item {
        background-color: white;
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px solid #ffc107;
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .similar-product-info {
        flex: 1;
    }

    .similar-product-details {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        flex-wrap: wrap;
    }

    .badge {
        background-color: #6c757d;
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-size: 0.75rem;
        font-family: monospace;
    }

    .match-score {
        font-weight: 600;
        color: #856404;
        white-space: nowrap;
    }

    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }


    .info-field {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .info-field label {
        font-weight: 600;
        min-width: 120px;
        margin: 0;
    }

    .info-field span {
        flex: 1;
    }

    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .radio-option:hover {
        background-color: #f8f9fa;
    }

    .radio-option input[type="radio"] {
        margin: 0;
        cursor: pointer;
    }

    .radio-option span {
        flex: 1;
    }

    .mt-2 {
        margin-top: 0.5rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #0056b3;
    }

    .btn-primary:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnProductCreated { get; set; }

    private string barcodeInput = "";
    private bool isSearching = false;
    private bool isProductFound = false;
    private bool isSaving = false;
    private string? errorMessage;
    
    private BarcodeLookupProductDto? lookupResult;
    private string selectedNameOption = "title";
    private string customName = "";
    private decimal productPrice = 0;
    private string? productDescription;
    private string? existingProductWithBarcode;
    private List<SimilarProductDto>? similarProducts;

    private bool IsBarcodeValid()
    {
        if (string.IsNullOrWhiteSpace(barcodeInput))
            return false;
        
        // UPC, EAN, ISBN barcodes are typically 8-14 digits
        return System.Text.RegularExpressions.Regex.IsMatch(barcodeInput.Trim(), @"^[0-9]{8,14}$");
    }

    private async Task SearchBarcode()
    {
        if (string.IsNullOrWhiteSpace(barcodeInput))
            return;

        isSearching = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetFromJsonAsync<BarcodeLookupResponseDto>($"api/barcodelookup/{Uri.EscapeDataString(barcodeInput.Trim())}");

            if (response?.Success == true && response.Product != null)
            {
                lookupResult = response.Product;
                isProductFound = true;
                productDescription = response.Product.Description;
                selectedNameOption = "title";
                
                // Check for existing product with same barcode
                await CheckForDuplicateBarcode(lookupResult.Barcode);
                
                // Find similar products using fuzzy matching
                await FindSimilarProducts(lookupResult.Title, lookupResult.Manufacturer, lookupResult.Brand);
            }
            else
            {
                errorMessage = response?.ErrorMessage ?? "Product not found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching barcode: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task CheckForDuplicateBarcode(string barcode)
    {
        try
        {
            var existingProduct = await Http.GetFromJsonAsync<ProductDto>($"api/products/barcode/{Uri.EscapeDataString(barcode)}");
            if (existingProduct != null)
            {
                existingProductWithBarcode = existingProduct.Name;
            }
            else
            {
                existingProductWithBarcode = null;
            }
        }
        catch
        {
            // Product not found, which is good
            existingProductWithBarcode = null;
        }
    }

    private async Task FindSimilarProducts(string title, string? manufacturer, string? brand)
    {
        try
        {
            var allProducts = await Http.GetFromJsonAsync<List<ProductDto>>("api/products");
            if (allProducts == null || !allProducts.Any())
            {
                similarProducts = null;
                return;
            }

            var matches = new List<SimilarProductDto>();
            
            foreach (var product in allProducts)
            {
                var matchScore = CalculateSimilarityScore(product.Name, title, manufacturer, brand);
                if (matchScore >= 60) // Threshold for showing as similar
                {
                    matches.Add(new SimilarProductDto
                    {
                        Name = product.Name,
                        Barcode = product.Barcode,
                        Price = product.Price,
                        Description = product.Description,
                        MatchScore = matchScore
                    });
                }
            }

            similarProducts = matches.OrderByDescending(m => m.MatchScore).Take(5).ToList();
        }
        catch (Exception)
        {
            // Silently fail - fuzzy search is a nice-to-have feature
            // The user can still create the product even if similarity search fails
            similarProducts = null;
        }
    }

    private int CalculateSimilarityScore(string existingName, string newTitle, string? manufacturer, string? brand)
    {
        var searchTerms = new List<string> { newTitle };
        if (!string.IsNullOrWhiteSpace(manufacturer))
            searchTerms.Add(manufacturer);
        if (!string.IsNullOrWhiteSpace(brand))
            searchTerms.Add(brand);

        var existingLower = existingName.ToLowerInvariant();
        var maxScore = 0;

        foreach (var term in searchTerms)
        {
            var termLower = term.ToLowerInvariant();
            
            // Exact match
            if (existingLower == termLower)
                return 100;
            
            // Contains check
            if (existingLower.Contains(termLower))
                maxScore = Math.Max(maxScore, 90);
            else if (termLower.Contains(existingLower))
                maxScore = Math.Max(maxScore, 85);
            
            // Word matching
            var existingWords = existingLower.Split(new[] { ' ', '-', '_' }, StringSplitOptions.RemoveEmptyEntries);
            var termWords = termLower.Split(new[] { ' ', '-', '_' }, StringSplitOptions.RemoveEmptyEntries);
            
            var commonWords = existingWords.Intersect(termWords).Count();
            if (commonWords > 0)
            {
                var wordScore = (int)((double)commonWords / Math.Max(existingWords.Length, termWords.Length) * 80);
                maxScore = Math.Max(maxScore, wordScore);
            }
            
            // Levenshtein distance for similar spellings
            var distance = LevenshteinDistance(existingLower, termLower);
            var maxLength = Math.Max(existingLower.Length, termLower.Length);
            if (maxLength > 0)
            {
                var similarity = (int)((1.0 - (double)distance / maxLength) * 70);
                maxScore = Math.Max(maxScore, similarity);
            }
        }

        return maxScore;
    }

    private int LevenshteinDistance(string source, string target)
    {
        if (string.IsNullOrEmpty(source))
            return target?.Length ?? 0;
        if (string.IsNullOrEmpty(target))
            return source.Length;

        var matrix = new int[source.Length + 1, target.Length + 1];

        for (var i = 0; i <= source.Length; i++)
            matrix[i, 0] = i;
        for (var j = 0; j <= target.Length; j++)
            matrix[0, j] = j;

        for (var i = 1; i <= source.Length; i++)
        {
            for (var j = 1; j <= target.Length; j++)
            {
                var cost = (target[j - 1] == source[i - 1]) ? 0 : 1;
                matrix[i, j] = Math.Min(
                    Math.Min(matrix[i - 1, j] + 1, matrix[i, j - 1] + 1),
                    matrix[i - 1, j - 1] + cost);
            }
        }

        return matrix[source.Length, target.Length];
    }

    private void SelectNameOption(string option)
    {
        selectedNameOption = option;
    }

    private static string BuildCompositeProductName(string? prefix, string title)
    {
        var safePrefix = string.IsNullOrWhiteSpace(prefix) ? null : prefix.Trim();
        var safeTitle = string.IsNullOrWhiteSpace(title) ? "" : title.Trim();

        if (safePrefix == null)
        {
            return safeTitle;
        }

        return $"{safePrefix} - {safeTitle}";
    }

    private string GetSelectedProductName()
    {
        if (lookupResult == null) return "";

        var title = lookupResult.Title ?? string.Empty;

        return selectedNameOption switch
        {
            "title" => title,
            "manufacturer" => BuildCompositeProductName(lookupResult.Manufacturer, title),
            "brand" => BuildCompositeProductName(lookupResult.Brand, title),
            "custom" => customName,
            _ => title
        };
    }

    private bool IsFormValid()
    {
        if (lookupResult == null) return false;
        if (productPrice <= 0) return false;
        
        var productName = GetSelectedProductName();
        if (string.IsNullOrWhiteSpace(productName)) return false;

        return true;
    }

    private async Task SaveProduct()
    {
        if (!IsFormValid()) return;

        isSaving = true;
        errorMessage = null;

        try
        {
            var productName = GetSelectedProductName();
            
            var response = await Http.PostAsJsonAsync("api/products", new
            {
                name = productName,
                barcode = lookupResult!.Barcode,
                price = productPrice,
                description = productDescription
            });

            if (response.IsSuccessStatusCode)
            {
                await OnProductCreated.InvokeAsync();
                ResetAll();
                await Cancel();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Failed to create product. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating product: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(barcodeInput) && !isSearching)
        {
            await SearchBarcode();
        }
    }

    private void ResetSearch()
    {
        isProductFound = false;
        lookupResult = null;
        selectedNameOption = "title";
        customName = "";
        productPrice = 0;
        productDescription = null;
        errorMessage = null;
        existingProductWithBarcode = null;
        similarProducts = null;
    }

    private void ResetAll()
    {
        barcodeInput = "";
        ResetSearch();
    }

    private async Task Cancel()
    {
        ResetAll();
        await OnClose.InvokeAsync();
    }

    private class BarcodeLookupResponseDto
    {
        public bool Success { get; set; }
        public string? ErrorMessage { get; set; }
        public BarcodeLookupProductDto? Product { get; set; }
    }

    private class BarcodeLookupProductDto
    {
        public required string Title { get; set; }
        public string? Manufacturer { get; set; }
        public string? Brand { get; set; }
        public string? Description { get; set; }
        public string? Category { get; set; }
        public string Barcode { get; set; } = string.Empty;
    }

    private class ProductDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Barcode { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public string? Description { get; set; }
    }

    private class SimilarProductDto
    {
        public string Name { get; set; } = string.Empty;
        public string Barcode { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public string? Description { get; set; }
        public int MatchScore { get; set; }
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }
}
