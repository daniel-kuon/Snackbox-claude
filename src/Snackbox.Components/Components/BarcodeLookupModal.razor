@inject HttpClient Http

@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="Cancel"></div>
    <div class="modal-dialog barcode-lookup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Lookup Product Barcode</h3>
                <button class="btn-close" @onclick="Cancel">&times;</button>
            </div>
            <div class="modal-body">
                @if (errorMessage != null)
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }

                @if (!isProductFound)
                {
                    <!-- Barcode Search Section -->
                    <div class="form-group">
                        <label>Barcode</label>
                        <div class="input-with-button">
                            <input type="text" 
                                   @bind="barcodeInput" 
                                   @bind:event="oninput"
                                   @onkeypress="HandleKeyPress"
                                   class="form-control" 
                                   placeholder="Enter barcode number"
                                   disabled="@isSearching" />
                            <button class="btn btn-primary" 
                                    @onclick="SearchBarcode" 
                                    disabled="@(isSearching || string.IsNullOrWhiteSpace(barcodeInput))">
                                @if (isSearching)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <span>Search</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Product Information Display -->
                    <div class="product-info-section">
                        <h4>Product Information</h4>
                        
                        <div class="info-field">
                            <label>Title:</label>
                            <span>@lookupResult?.Title</span>
                        </div>
                        
                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Manufacturer))
                        {
                            <div class="info-field">
                                <label>Manufacturer:</label>
                                <span>@lookupResult.Manufacturer</span>
                            </div>
                        }
                        
                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Brand))
                        {
                            <div class="info-field">
                                <label>Brand:</label>
                                <span>@lookupResult.Brand</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(lookupResult?.Category))
                        {
                            <div class="info-field">
                                <label>Category:</label>
                                <span>@lookupResult.Category</span>
                            </div>
                        }
                    </div>

                    <!-- Product Name Selection -->
                    <div class="form-group">
                        <label>Product Name</label>
                        
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="nameOption" value="title" 
                                       @onchange='() => SelectNameOption("title")' 
                                       checked="@(selectedNameOption == "title")" />
                                <span>@lookupResult?.Title</span>
                            </label>

                            @if (!string.IsNullOrWhiteSpace(lookupResult?.Manufacturer))
                            {
                                <label class="radio-option">
                                    <input type="radio" name="nameOption" value="manufacturer" 
                                           @onchange='() => SelectNameOption("manufacturer")' 
                                           checked="@(selectedNameOption == "manufacturer")" />
                                    <span>@lookupResult.Manufacturer - @lookupResult.Title</span>
                                </label>
                            }

                            @if (!string.IsNullOrWhiteSpace(lookupResult?.Brand))
                            {
                                <label class="radio-option">
                                    <input type="radio" name="nameOption" value="brand" 
                                           @onchange='() => SelectNameOption("brand")' 
                                           checked="@(selectedNameOption == "brand")" />
                                    <span>@lookupResult.Brand - @lookupResult.Title</span>
                                </label>
                            }

                            <label class="radio-option">
                                <input type="radio" name="nameOption" value="custom" 
                                       @onchange='() => SelectNameOption("custom")' 
                                       checked="@(selectedNameOption == "custom")" />
                                <span>Custom Name</span>
                            </label>
                        </div>

                        @if (selectedNameOption == "custom")
                        {
                            <input type="text" 
                                   @bind="customName" 
                                   @bind:event="oninput"
                                   class="form-control mt-2" 
                                   placeholder="Enter custom product name" />
                        }
                    </div>

                    <!-- Price Field -->
                    <div class="form-group">
                        <label>Price (â‚¬)</label>
                        <input type="number" 
                               @bind="productPrice" 
                               @bind:event="oninput"
                               class="form-control" 
                               step="0.01" 
                               min="0"
                               placeholder="0.00" />
                    </div>

                    <!-- Description Field -->
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea @bind="productDescription" 
                                  @bind:event="oninput"
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Enter product description">@(lookupResult?.Description ?? "")</textarea>
                    </div>
                }
            </div>
            
            <div class="modal-footer">
                @if (isProductFound)
                {
                    <button type="button" class="btn btn-secondary" @onclick="ResetSearch">Back to Search</button>
                }
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                @if (isProductFound)
                {
                    <button type="button" class="btn btn-primary" @onclick="SaveProduct" disabled="@(isSaving || !IsFormValid())">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        Create Product
                    </button>
                }
            </div>
        </div>
    </div>
}

<style>
    .barcode-lookup-modal {
        max-width: 600px;
    }

    .input-with-button {
        display: flex;
        gap: 0.5rem;
    }

    .input-with-button .form-control {
        flex: 1;
    }

    .input-with-button .btn {
        white-space: nowrap;
    }

    .product-info-section {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .product-info-section h4 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .info-field {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .info-field label {
        font-weight: 600;
        min-width: 120px;
        margin: 0;
    }

    .info-field span {
        flex: 1;
    }

    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .radio-option:hover {
        background-color: #f8f9fa;
    }

    .radio-option input[type="radio"] {
        margin: 0;
        cursor: pointer;
    }

    .radio-option span {
        flex: 1;
    }

    .mt-2 {
        margin-top: 0.5rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .modal-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #0056b3;
    }

    .btn-primary:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spinner-border 0.75s linear infinite;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnProductCreated { get; set; }

    private string barcodeInput = "";
    private bool isSearching = false;
    private bool isProductFound = false;
    private bool isSaving = false;
    private string? errorMessage;
    
    private BarcodeLookupProductDto? lookupResult;
    private string selectedNameOption = "title";
    private string customName = "";
    private decimal productPrice = 0;
    private string? productDescription;

    private async Task SearchBarcode()
    {
        if (string.IsNullOrWhiteSpace(barcodeInput))
            return;

        isSearching = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetFromJsonAsync<BarcodeLookupResponseDto>($"api/barcodelookup/{Uri.EscapeDataString(barcodeInput.Trim())}");

            if (response?.Success == true && response.Product != null)
            {
                lookupResult = response.Product;
                isProductFound = true;
                productDescription = response.Product.Description;
                selectedNameOption = "title";
            }
            else
            {
                errorMessage = response?.ErrorMessage ?? "Product not found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching barcode: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private void SelectNameOption(string option)
    {
        selectedNameOption = option;
    }

    private string GetSelectedProductName()
    {
        if (lookupResult == null) return "";

        return selectedNameOption switch
        {
            "title" => lookupResult.Title,
            "manufacturer" => $"{lookupResult.Manufacturer} - {lookupResult.Title}",
            "brand" => $"{lookupResult.Brand} - {lookupResult.Title}",
            "custom" => customName,
            _ => lookupResult.Title
        };
    }

    private bool IsFormValid()
    {
        if (lookupResult == null) return false;
        if (productPrice <= 0) return false;
        
        var productName = GetSelectedProductName();
        if (string.IsNullOrWhiteSpace(productName)) return false;

        return true;
    }

    private async Task SaveProduct()
    {
        if (!IsFormValid()) return;

        isSaving = true;
        errorMessage = null;

        try
        {
            var productName = GetSelectedProductName();
            
            var response = await Http.PostAsJsonAsync("api/products", new
            {
                name = productName,
                barcode = lookupResult!.Barcode,
                price = productPrice,
                description = productDescription
            });

            if (response.IsSuccessStatusCode)
            {
                await OnProductCreated.InvokeAsync();
                ResetAll();
                await Cancel();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Failed to create product. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating product: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(barcodeInput) && !isSearching)
        {
            await SearchBarcode();
        }
    }

    private void ResetSearch()
    {
        isProductFound = false;
        lookupResult = null;
        selectedNameOption = "title";
        customName = "";
        productPrice = 0;
        productDescription = null;
        errorMessage = null;
    }

    private void ResetAll()
    {
        barcodeInput = "";
        ResetSearch();
    }

    private async Task Cancel()
    {
        ResetAll();
        await OnClose.InvokeAsync();
    }

    private class BarcodeLookupResponseDto
    {
        public bool Success { get; set; }
        public string? ErrorMessage { get; set; }
        public BarcodeLookupProductDto? Product { get; set; }
    }

    private class BarcodeLookupProductDto
    {
        public required string Title { get; set; }
        public string? Manufacturer { get; set; }
        public string? Brand { get; set; }
        public string? Description { get; set; }
        public string? Category { get; set; }
        public string Barcode { get; set; } = string.Empty;
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }
}
