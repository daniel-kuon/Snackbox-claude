@page "/scan"
@layout EmptyLayout
@inject WindowsScannerListener ScannerListener
@inject IScannerService ScannerService
@inject NavigationManager Navigation
@using System.Timers
@using Snackbox.Components.Components
@using Snackbox.Components.Models
@using Snackbox.Web.Components.Layout
@using Snackbox.Web.Services
@implements IDisposable

<PageTitle>Snackbox Scanner</PageTitle>

<!-- Achievement Notification Overlay -->
@if (ScannerService.CurrentSession?.NewAchievements.Any() == true)
{
    <AchievementNotification 
        Achievements="@ScannerService.CurrentSession.NewAchievements" 
        CurrentScanInfo="@GetCurrentScanInfo()" />
}

<div class="scanner-container">
    @if (_errorMessage != null)
    {
        <div class="error-toast">@_errorMessage</div>
    }

    @if (!ScannerService.IsSessionActive)
    {
        <!-- Welcome Screen: Waiting for user to scan -->
        <div class="scan-prompt-container">
            <div class="scan-prompt-content">
                <div class="scan-icon">ðŸ“±</div>
                <h1 class="scan-title">Welcome to Snackbox</h1>
                <p class="scan-instruction">Please scan your card to continue</p>
            </div>
        </div>
    }
    else if (ScannerService.CurrentSession != null)
    {
        var session = ScannerService.CurrentSession;

        <!-- Active Purchase Session -->
        <div class="scanner-active" @key="session.UserId">
            <!-- Main content area -->
            <div class="scanner-content">
                <!-- Left side: Purchase items and totals -->
                <div class="purchase-section">
                    <!-- Timer at top of purchase section -->
                    <div class="timer-container">
                        <div class="timer-circle">
                            <span class="timer-text">@_remainingSeconds</span>
                        </div>
                    </div>
                    <h3 class="section-title">Scanned Amounts</h3>

                    @if (session.ScannedBarcodes.Any())
                    {
                        <div class="items-list">
                            @foreach (var barcode in session.ScannedBarcodes.GroupBy(c => c.Amount))
                            {
                                <div class="purchase-item">
                                    <span class="item-price">@barcode.Count() x @barcode.Key.ToString("C")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-items">
                            <p>Scan your personal barcodes to add amounts</p>
                        </div>
                    }

                    <div class="purchase-total">
                        <span class="total-label">Total:</span>
                        <span class="total-amount">@session.TotalAmount.ToString("C")</span>
                    </div>

                    <!-- Last payment info -->
                    @if (session.LastPaymentDate.HasValue)
                    {
                        <div class="last-payment">
                            <div class="payment-label">Last Payment:</div>
                            <div class="payment-details">
                                <span class="payment-amount">@session.LastPaymentAmount.ToString("C")</span>
                                <span class="payment-date">@session.LastPaymentDate.Value.ToString("dd MMM yyyy")</span>
                            </div>
                        </div>
                    }

                    <!-- Recent purchases -->
                    <div class="recent-purchases">
                        <h4 class="recent-title">Recent Purchases (@session.RecentPurchases.Count)</h4>
                        @if (session.RecentPurchases.Any())
                        {
                            <div class="recent-list">
                                @foreach (var purchase in session.RecentPurchases)
                                {
                                    <div class="recent-item">
                                        <div class="recent-info">
                                            <span class="recent-date">@purchase.CompletedAt.ToString("dd MMM HH:mm")</span>
                                            <span class="recent-items">@purchase.ItemCount item@(purchase.ItemCount != 1 ? "s" : "")</span>
                                        </div>
                                        <span class="recent-amount">@purchase.TotalAmount.ToString("C")</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">No recent purchases</p>
                        }
                    </div>
                </div>

                <!-- Right side: User Info & QR Code -->
                <div class="qr-section">
                    <!-- User info at top -->
                    <div class="user-info-box">
                        <h2 class="user-name">@session.UserName</h2>
                        <div class="user-balance">
                            <span class="balance-label">@(session.OpenAmount > 0 ? "Open Payment:" : "Deposit:")</span>
                            <span class="balance-amount @(session.OpenAmount > 0 ? "positive" : "negative")">
                                @Math.Abs(session.OpenAmount).ToString("C")
                            </span>
                        </div>
                    </div>

                    <!-- QR Code -->
                    <h3 class="section-title" style="margin-bottom: -2rem; z-index: 10">Pay via PayPal</h3>
                    <div class="qr-code-wrapper">
                        <QRCodeComponent PayPalUrl="@($"https://paypal.me/dkuon/{Math.Abs(session.OpenAmount):F2}")" Size="250" />
                    </div>
                    <p class="qr-instruction">Scan to pay @Math.Abs(session.OpenAmount).ToString("C") or go to https://paypal.me/dkuon/@(Math.Abs(session.OpenAmount).ToString("F2"))<br />
                    Payments will not show up instantly.</p>

                    <!-- Scan instruction -->
                    <div class="scan-instruction-box">
                        <p>Continue scanning or wait for auto-complete</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .scanner-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }

    .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .scan-prompt-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .scan-prompt-content {
        text-align: center;
        color: white;
        padding: 3rem;
    }

    .scan-icon {
        font-size: 8rem;
        margin-bottom: 2rem;
        animation: pulse 2s ease-in-out infinite;
    }

    .scan-title {
        font-size: 3rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .scan-instruction {
        font-size: 1.5rem;
        opacity: 0.9;
        font-weight: 300;
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }

    /* Active scanner styles */
    .scanner-active {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100vh;
        padding: 0.5rem;
        background: #f8f9fa;
        box-sizing: border-box;
    }

    .scanner-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        flex: 1;
        overflow: hidden;
    }

    .timer-container {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .timer-circle {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .timer-text {
        font-size: 1.8rem;
        font-weight: 600;
        color: white;
    }

    .purchase-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .qr-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .section-title {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.3rem;
    }

    .items-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
        min-height: 0;
    }

    .purchase-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
    }

    .purchase-item:last-child {
        border-bottom: none;
    }

    .item-name {
        color: #666;
    }

    .item-price {
        font-weight: 600;
        color: #333;
    }

    .no-items {
        text-align: center;
        padding: 2rem;
        color: #999;
    }

    .purchase-total {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .last-payment {
        padding: 0.75rem;
        background: #e7f3ff;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        margin-bottom: 1rem;
    }

    .payment-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.3rem;
    }

    .payment-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .payment-amount {
        font-weight: 600;
        color: #007bff;
        font-size: 1.1rem;
    }

    .payment-date {
        color: #666;
        font-size: 0.85rem;
    }

    /* User info box in QR section */
    .user-info-box {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .user-name {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-size: 1.5rem;
    }

    .user-balance {
        font-size: 1.1rem;
    }

    .balance-label {
        color: #333;
        margin-right: 0.5rem;
    }

    .balance-amount {
        font-weight: 600;
    }

    .balance-amount.positive {
        color: #dc3545;
    }

    .balance-amount.negative {
        color: #28a745;
    }

    .qr-code-wrapper {
        display: flex;
        justify-content: center;
        margin: 0;
    }

    .qr-instruction {
        text-align: center;
        color: #333;
        font-size: 1rem;
        margin-bottom: -1rem;
        margin-top: -2rem;
    }

    .scan-instruction-box {
        margin-top: auto;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: center;
    }

    .scan-instruction-box p {
        margin: 0;
        color: #333;
        font-size: 0.9rem;
        height: 27px;
    }

    /* Recent Purchases */
    .recent-purchases {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .recent-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
        margin: 0 0 0.5rem 0;
    }

    .recent-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .recent-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: white;
        border-radius: 6px;
        border-left: 3px solid #667eea;
    }

    .recent-info {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .recent-date {
        font-size: 0.85rem;
        font-weight: 500;
        color: #333;
    }

    .recent-items {
        font-size: 0.75rem;
        color: #666;
    }

    .recent-amount {
        font-size: 0.95rem;
        font-weight: 700;
        color: #667eea;
    }
</style>

@code {
    private int _remainingSeconds;
    private Timer? _countdownTimer;
    private string? _errorMessage;
    private Timer? _errorTimer;

    protected override void OnInitialized()
    {

        // Subscribe to scanner events
        ScannerListener.CodeReceived += HandleCodeScanned;

        // Subscribe to service events
        ScannerService.OnPurchaseStarted += HandlePurchaseStarted;
        ScannerService.OnPurchaseUpdated += HandlePurchaseUpdated;
        ScannerService.OnPurchaseCompleted += HandlePurchaseCompleted;
        ScannerService.OnPurchaseTimeout += HandlePurchaseTimeout;

        // Start listening for scanner input
        ScannerListener.Start();
    }

    private async void HandleCodeScanned(string code)
    {
        try
        {
            // First check if this is an admin scan
            var scanResult = await ScannerService.ScanBarcodeAsync(code);

            if (scanResult is { IsSuccess: true, IsAdmin: true })
            {
                // Admin code detected - redirect to barcode login page with barcode pre-filled
                await InvokeAsync(() =>
                {
                    Navigation.NavigateTo($"/barcode-login?barcode={Uri.EscapeDataString(code)}");
                });
                return;
            }

            // Process the barcode through the service for regular users
            await ScannerService.ProcessBarcodeAsync(code);
        }
        catch {
            ShowError("Barcode not recognized");
        }
    }

    private void HandlePurchaseStarted(PurchaseSession session)
    {
        _remainingSeconds = ScannerService.TimeoutSeconds;
        StartCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseUpdated(PurchaseSession session)
    {
        ResetCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseCompleted()
    {
        StopCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void HandlePurchaseTimeout()
    {
        StopCountdownTimer();
        InvokeAsync(StateHasChanged);
    }

    private void StartCountdownTimer()
    {
        _countdownTimer = new Timer(1000);
        _countdownTimer.Elapsed += (_, _) =>
        {
            _remainingSeconds--;
            InvokeAsync(StateHasChanged);

            if (_remainingSeconds <= 0)
            {
                StopCountdownTimer();
            }
        };
        _countdownTimer.Start();
    }

    private void ResetCountdownTimer()
    {
        StopCountdownTimer();
        _remainingSeconds = ScannerService.TimeoutSeconds;
        StartCountdownTimer();
    }

    private void StopCountdownTimer()
    {
        if (_countdownTimer != null)
        {
            _countdownTimer.Stop();
            _countdownTimer.Dispose();
            _countdownTimer = null;
        }
    }

    private void ShowError(string message)
    {
        _errorMessage = message;
        InvokeAsync(StateHasChanged);

        // Auto-hide error after 5 seconds
        _errorTimer?.Dispose();
        _errorTimer = new Timer(5000);
        _errorTimer.Elapsed += (_, _) =>
        {
            _errorMessage = null;
            InvokeAsync(StateHasChanged);
            _errorTimer?.Dispose();
        };
        _errorTimer.AutoReset = false;
        _errorTimer.Start();
    }

    private string GetCurrentScanInfo()
    {
        if (ScannerService.CurrentSession == null)
            return string.Empty;

        var session = ScannerService.CurrentSession;
        if (session.ScannedBarcodes.Any())
        {
            var lastScan = session.ScannedBarcodes.Last();
            return $"{lastScan.Amount:C}";
        }

        return $"Total: {session.TotalAmount:C}";
    }

    public void Dispose()
    {
        ScannerListener.CodeReceived -= HandleCodeScanned;
        ScannerService.OnPurchaseStarted -= HandlePurchaseStarted;
        ScannerService.OnPurchaseUpdated -= HandlePurchaseUpdated;
        ScannerService.OnPurchaseCompleted -= HandlePurchaseCompleted;
        ScannerService.OnPurchaseTimeout -= HandlePurchaseTimeout;

        StopCountdownTimer();
        _errorTimer?.Dispose();
    }
}
